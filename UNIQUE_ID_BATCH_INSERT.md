# Unique ID Generation for Batch Insert Operations

## Overview

This document describes the implementation of unique ID generation for batch insert operations in the BUCKET_INSTANCE table.

## Problem Statement

Previously, the `BucketInstanceDataGenerator` used a simple `AtomicLong` counter starting from `System.currentTimeMillis()` to generate IDs for batch inserts. This approach had several issues:

1. **Potential ID Collisions**: Starting from system time could cause collisions in distributed environments
2. **Gaps in ID Sequences**: Manual ID generation created gaps and inconsistencies
3. **Incompatibility with IDENTITY Column**: The BUCKET_INSTANCE table was defined with `GENERATED ALWAYS AS IDENTITY`, which prevents manual ID insertion

## Solution

The implementation now uses an Oracle database sequence (`BUCKET_INSTANCE_SEQ`) for generating unique IDs during batch insert operations.

### Key Components

#### 1. Database Sequence

**File**: `src/main/resources/db/create-bucket-sequence.sql` (standalone) or included in `init-service-bucket-tables.sql`

```sql
CREATE SEQUENCE BUCKET_INSTANCE_SEQ
    START WITH 1
    INCREMENT BY 1
    MINVALUE 1
    MAXVALUE 9999999999999999999999999999
    CACHE 1000
    NOORDER
    NOCYCLE;
```

**Features**:
- Cache size of 1000 for optimal batch performance
- No ordering to allow concurrent access
- No cycling to prevent ID reuse

#### 2. Table Schema Update

**File**: `src/main/resources/db/init-service-bucket-tables.sql`

Changed the BUCKET_INSTANCE table ID column from:
```sql
GENERATED ALWAYS AS IDENTITY
```

to:
```sql
GENERATED BY DEFAULT AS IDENTITY
```

**Why?**
- `GENERATED ALWAYS` - Database always generates ID, cannot insert manually
- `GENERATED BY DEFAULT` - Database generates ID if not provided, allows manual specification

This change allows:
1. Automatic ID generation for single inserts (when ID is omitted)
2. Manual ID specification for batch inserts (using sequence values)

#### 3. BucketInstanceDataGenerator Updates

**File**: `src/main/java/com/csg/airtel/aaa4j/scripts/BucketInstanceDataGenerator.java`

**Changes Made**:

1. **Removed AtomicLong-based ID generation**:
   ```java
   // OLD - REMOVED
   private static final AtomicLong UNIQUE_ID_GENERATOR = new AtomicLong(System.currentTimeMillis());
   private long generateUniqueId() {
       return UNIQUE_ID_GENERATOR.incrementAndGet();
   }
   ```

2. **Added sequence-based ID generation**:
   ```java
   // NEW
   private Uni<List<Long>> generateIds(int batchSize) {
       String sql = "SELECT BUCKET_INSTANCE_SEQ.NEXTVAL FROM DUAL CONNECT BY LEVEL <= ?";
       return client.preparedQuery(sql)
           .execute(Tuple.of(batchSize))
           .onItem().transform(rows -> {
               List<Long> ids = new ArrayList<>(batchSize);
               for (Row row : rows) {
                   ids.add(row.getLong(0));
               }
               return ids;
           });
   }
   ```

3. **Updated batch processing workflow**:
   - For each batch of service IDs
   - Fetch a batch of unique IDs from the sequence
   - Create BucketInstanceRecord objects with the generated IDs
   - Insert the batch into the database

## Benefits

1. **Thread-Safe**: Database sequence handles concurrency automatically
2. **Collision-Free**: Guaranteed unique IDs across all instances
3. **Performance**: Batch fetching of sequence values (1 DB call per batch instead of 1 per record)
4. **Scalability**: Works in distributed environments
5. **Consistency**: IDs follow a predictable sequence
6. **Flexibility**: Table supports both auto-generated and manual IDs

## Database Setup

### Option 1: Use Complete Init Script

```bash
sqlplus username/password@database @src/main/resources/db/init-service-bucket-tables.sql
```

This script creates:
- SERVICE_INSTANCE table
- BUCKET_INSTANCE table (with GENERATED BY DEFAULT AS IDENTITY)
- BUCKET_INSTANCE_SEQ sequence
- All necessary indexes

### Option 2: Add Sequence to Existing Database

If tables already exist, just add the sequence:

```bash
sqlplus username/password@database @src/main/resources/db/create-bucket-sequence.sql
```

And update the BUCKET_INSTANCE table:

```sql
-- Only needed if table was created with GENERATED ALWAYS
ALTER TABLE BUCKET_INSTANCE MODIFY (
    ID NUMBER(19,0) GENERATED BY DEFAULT AS IDENTITY
);
```

## Usage

The `BucketInstanceDataGenerator` automatically uses the sequence for ID generation:

```java
@Inject
BucketInstanceDataGenerator generator;

// Generate bucket instances (IDs are automatically fetched from sequence)
Uni<GenerationResult> result = generator.generateDataBucket();
```

## Performance

With batch size of 5000 and CACHE 1000:
- **1 sequence query per 5000 records** (fetches all IDs in one call)
- **Minimal overhead** compared to application-generated IDs
- **Better performance** than individual NEXTVAL calls

## Migration Notes

If you have existing data:

1. **Check maximum ID in BUCKET_INSTANCE**:
   ```sql
   SELECT MAX(ID) FROM BUCKET_INSTANCE;
   ```

2. **Adjust sequence start value**:
   ```sql
   ALTER SEQUENCE BUCKET_INSTANCE_SEQ RESTART START WITH <max_id + 1>;
   ```

## Troubleshooting

### Issue: "cannot insert into generated always identity column"

**Solution**: Table needs `GENERATED BY DEFAULT` instead of `GENERATED ALWAYS`

```sql
ALTER TABLE BUCKET_INSTANCE MODIFY (
    ID NUMBER(19,0) GENERATED BY DEFAULT AS IDENTITY
);
```

### Issue: "sequence does not exist"

**Solution**: Create the sequence using the provided scripts

```bash
sqlplus username/password@database @src/main/resources/db/create-bucket-sequence.sql
```

### Issue: Duplicate key error

**Solution**: Sequence may be out of sync with existing data. Reset sequence:

```sql
-- Find max ID
SELECT MAX(ID) FROM BUCKET_INSTANCE;

-- Reset sequence (replace <max_id> with actual value)
DROP SEQUENCE BUCKET_INSTANCE_SEQ;
CREATE SEQUENCE BUCKET_INSTANCE_SEQ START WITH <max_id + 1> ...;
```

## References

- BucketInstanceDataGenerator.java:398 - `generateIds()` method
- init-service-bucket-tables.sql:78 - BUCKET_INSTANCE table definition
- init-service-bucket-tables.sql:154 - BUCKET_INSTANCE_SEQ definition
